<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Secret Page</title>
</head>
<body>
  <h1 id="secretText">‚è≥ Loading...</h1>
  <button id="logoutBtn">Logout</button>

  <h2>User settings</h2>
  <label>First name: <input type="text" id="firstName"></label><br>
  <label>Last name: <input type="text" id="lastName"></label><br>
  <button onclick="updateProfile()">Save profile</button>

  <h3>Change password</h3>
  <input type="password" id="currentPassword" placeholder="Current password"><br>
  <input type="password" id="newPassword" placeholder="New password"><br>
  <button onclick="changePassword()">Save</button>


  <script src="https://cdn.jsdelivr.net/npm/keycloak-js@latest/dist/keycloak.min.js"></script>
<script>
  const keycloak = new Keycloak({
    url: "http://localhost:8080/",
    realm: "myrealm",
    clientId: "simple-web"
  });

  let accessToken = "";

  keycloak.init({ onLoad: 'login-required' }).then(authenticated => {
    if (authenticated) {
      accessToken = keycloak.token;
      console.log("Access token:", accessToken);
      const username = keycloak.tokenParsed?.preferred_username || "user";
      document.getElementById("secretText").innerText = `Hello ${username}, this is your secret page`;

      fetch(`http://localhost:3000/admin/user/${username}`)
  .then(res => res.json())
  .then(data => {
    document.getElementById("firstName").value = data.firstName || "";
    document.getElementById("lastName").value = data.lastName || "";
  });

    }
  });

  function updateProfile() {
    const firstName = document.getElementById("firstName").value;
    const lastName = document.getElementById("lastName").value;
    const email = keycloak.tokenParsed?.email || "";
    const username = keycloak.tokenParsed?.preferred_username || "";

    // Stap 1: userId ophalen
    fetch(`http://localhost:3000/admin/user-id?username=${username}`)
      .then(res => res.json())
      .then(data => {
        const userId = data.id;

        // Stap 2: profiel bijwerken
        fetch(`http://localhost:3000/admin/update-user/${userId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ firstName, lastName, email, username })
        }).then(res => {
          if (res.ok) alert("‚úÖ Profiel bijgewerkt");
          else res.text().then(text => alert("‚ùå Fout:\n" + text));
        });
      });
  }

  function changePassword() {
    const currentPassword = document.getElementById("currentPassword").value;
    const newPassword = document.getElementById("newPassword").value;
    const username = keycloak.tokenParsed?.preferred_username || "";

    // Stap 1: userId ophalen
    fetch(`http://localhost:3000/admin/user-id?username=${username}`)
      .then(res => res.json())
      .then(data => {
        const userId = data.id;

        // Stap 2: wachtwoord resetten
        fetch(`http://localhost:3000/admin/reset-password/${userId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ newPassword })
        }).then(res => {
          if (res.ok) alert("üîê Wachtwoord gewijzigd");
          else res.text().then(text => alert("‚ùå Fout:\n" + text));
        });
      });
  }


  document.getElementById("logoutBtn").onclick = () =>
    keycloak.logout({ redirectUri: 'http://127.0.0.1:5500/frontend/index.html' });
</script>
</body>
</html>
